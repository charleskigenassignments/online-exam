<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Secure Mobile Exam Portal</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-user-select: none; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #0d1117; color: #c9d1d9; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Setup Container */
        #setup { display: flex; justify-content: center; align-items: center; flex: 1; padding: 20px; z-index: 100; }
        .box { background: #161b22; padding: 25px; border-radius: 12px; border: 1px solid #30363d; width: 100%; max-width: 400px; text-align: center; }
        input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 6px; border: 1px solid #30363d; background: #0d1117; color: white; font-size: 16px; }
        .btn { background: #238636; color: white; border: none; padding: 14px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }
        .btn:disabled { background: #21262d; color: #8b949e; }

        /* MOBILE FIX: Bottom Status Bar (Always Visible) */
        #statusBar { display: none; position: fixed; bottom: 0; left: 0; width: 100%; background: #161b22; padding: 12px 20px; border-top: 1px solid #30363d; z-index: 9999; }
        .status-flex { display: flex; justify-content: space-between; align-items: center; }
        #examTimer { font-family: monospace; font-size: 20px; color: #58a6ff; font-weight: bold; }
        
        /* Elements */
        #iframeContainer { flex: 1; display: none; width: 100%; height: calc(100vh - 55px); background: white; -webkit-overflow-scrolling: touch; }
        iframe { width: 100%; height: 100%; border: none; }
        
        #overlay, #countdownOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10001; justify-content: center; align-items: center; flex-direction: column; text-align: center; padding: 30px; }
        #overlay { background: #8b0000; color: white; }
        #countdownOverlay { background: rgba(0,0,0,0.95); color: #f85149; }
        .timer-warning { color: #f85149 !important; }
    </style>
</head>
<body oncontextmenu="return false;">

<div id="setup">
    <div class="box">
        <h2 style="margin-bottom:15px;">Exam Verification</h2>
        <input type="text" id="uName" placeholder="Full Name">
        <input type="text" id="uReg" placeholder="Registration Number">
        <div style="display: flex; gap: 5px;">
            <input type="email" id="uEmail" placeholder="Gmail">
            <button onclick="sendOTP()" id="otpBtn" style="width:90px; height:42px; margin-top:8px; font-size:12px;">Get OTP</button>
        </div>
        <input type="text" id="otpIn" placeholder="4-Digit OTP" style="display:none; text-align:center;">
        <button id="startBtn" class="btn" onclick="syncAndStart()">START EXAM</button>
    </div>
</div>

<div id="countdownOverlay"><h1 id="countDisp" style="font-size: 80px;">10</h1><h2>RETURN IMMEDIATELY</h2></div>

<div id="iframeContainer"><iframe id="examFrame" src=""></iframe></div>

<div id="statusBar">
    <div class="status-flex">
        <span id="strikeText" style="color:#238636; font-size:12px;">● PROCTORING ACTIVE</span>
        <span id="examTimer">00:00:00</span>
    </div>
</div>

<div id="overlay">
    <h1>SESSION LOCKED</h1>
    <p id="lockReason" style="margin: 20px 0;">Security policy violation.</p>
    <input type="text" id="reKey" placeholder="Instructor Reset Key" style="background:white; color:black; max-width:250px;">
    <button onclick="unlock()" class="btn" style="max-width:250px;">RESUME EXAM</button>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyYxD9zAh4mtyQyoPKnlzx9fvzFEqKPmBqpq5oliET4Luk5PSoveU_jHoavVKKDeTFj0g/exec"; 
    const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSfimbqiEg3fuQGit-6ZEcIbmdrQOmCR_-KSFVnLMKWvVrY7Vg/viewform?usp=header";


    let state = { active: false, violations: 0, timeLeft: 0, leaveTime: null, otp: null, masterKey: null };

    function sendOTP() {
        const email = document.getElementById('uEmail').value;
        if(!email.includes('@')) return alert("Enter valid email");
        document.getElementById('otpBtn').innerText = "...";
        fetch(`${SCRIPT_URL}?action=sendOTP&email=${encodeURIComponent(email)}`)
            .then(r => r.text()).then(code => {
                state.otp = code.trim();
                document.getElementById('otpIn').style.display = "block";
                document.getElementById('otpBtn').innerText = "Sent";
            });
    }

    async function syncAndStart() {
        if (document.getElementById('otpIn').value !== state.otp) return alert("Invalid OTP");
        
        const res = await fetch(`${SCRIPT_URL}?action=getSettings`);
        const data = await res.json();
        state.timeLeft = data.duration * 60;
        state.masterKey = data.resetKey;

        // Log Login
        fetch(`${SCRIPT_URL}?action=login&name=${encodeURIComponent(document.getElementById('uName').value)}&reg=${encodeURIComponent(document.getElementById('uReg').value)}&email=${encodeURIComponent(document.getElementById('uEmail').value)}`);

        document.getElementById('setup').style.display = 'none';
        document.getElementById('statusBar').style.display = 'block';
        document.getElementById('iframeContainer').style.display = 'block';
        document.getElementById('examFrame').src = FORM_URL;
        
        state.active = true;
        setInterval(updateTimer, 1000);

        // ANDROID FIX: Visibility API is better than 'blur' for mobile apps
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) handleLeave(); else handleReturn();
        });
        window.onblur = handleLeave;
        window.onfocus = handleReturn;
    }

    function updateTimer() {
        if (!state.active || state.timeLeft <= 0) return;
        state.timeLeft--;
        const m = Math.floor(state.timeLeft / 60);
        const s = state.timeLeft % 60;
        const timerDisp = document.getElementById('examTimer');
        timerDisp.innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        if (state.timeLeft < 300) timerDisp.classList.add('timer-warning');
        if (state.timeLeft === 0) lockExam("Time Expired");
    }

    function handleLeave() {
        // Delay check to prevent violation when Android keyboard opens
        setTimeout(() => {
            if (document.activeElement === document.getElementById('examFrame')) return;
            if (!state.active || state.leaveTime) return;

            state.leaveTime = Date.now();
            let limit = state.violations === 0 ? 10 : 5;
            document.getElementById('countdownOverlay').style.display = 'flex';
            
            let count = limit;
            state.vTick = setInterval(() => {
                count--;
                document.getElementById('countDisp').innerText = count > 0 ? count : 0;
                if (count <= 0) clearInterval(state.vTick);
            }, 1000);

            state.vTimer = setTimeout(() => { triggerStrike(); }, limit * 1000 + 500);
        }, 300);
    }

    function handleReturn() {
        if (!state.active || !state.leaveTime) return;
        clearInterval(state.vTick);
        clearTimeout(state.vTimer);
        document.getElementById('countdownOverlay').style.display = 'none';
        state.leaveTime = null;
    }

    function triggerStrike() {
        state.violations++;
        handleReturn();
        if (state.violations === 1) {
            document.getElementById('strikeText').innerText = "● SECURITY: 1 STRIKE";
            document.getElementById('strikeText').style.color = "#e3b341";
            alert("⚠️ WARNING: One more tab switch will lock the exam.");
        } else {
            lockExam("Multiple Tab Switches");
        }
    }

    function lockExam(reason) {
        state.active = false;
        document.getElementById('iframeContainer').style.display = 'none';
        document.getElementById('statusBar').style.display = 'none';
        document.getElementById('overlay').style.display = 'flex';
        document.getElementById('lockReason').innerText = reason;
        
        fetch(`${SCRIPT_URL}?name=${encodeURIComponent(document.getElementById('uName').value)}&reg=${encodeURIComponent(document.getElementById('uReg').value)}&email=${encodeURIComponent(document.getElementById('uEmail').value)}&violation=${encodeURIComponent(reason)}`);
    }

    function unlock() {
        if (document.getElementById('reKey').value === state.masterKey.toString()) {
            state.active = true; state.violations = 0;
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('statusBar').style.display = 'block';
            document.getElementById('iframeContainer').style.display = 'block';
            document.getElementById('strikeText').innerText = "● MONITORING ACTIVE (RESET)";
            document.getElementById('strikeText').style.color = "#238636";
        } else { alert("Wrong Key"); }
    }
</script>
</body>
</html>
